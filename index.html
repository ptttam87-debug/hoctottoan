<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mathpro - H·ªá Th·ªëng H·ªçc & Thi</title>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f3f4f6; --txt: #1f2937; --success: #22c55e; --warning: #eab308; --danger: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--txt); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* AUTH & MODAL */
        #auth-overlay, #info-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        #info-modal { background: rgba(0,0,0,0.8); z-index: 10000; display: none; }
        .auth-card, .modal-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 360px; text-align: center; border: 1px solid #ddd; }
        .inp { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 12px 20px; background: var(--p); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; width: 100%; margin-top: 10px; }
        .btn:hover { opacity: 0.9; } .btn:active { transform: scale(0.95); }
        .google-btn { display: flex; align-items: center; justify-content: center; background: white; border: 1px solid #ccc; color: #333; margin-top: 15px; }
        .g-icon { width: 18px; height: 18px; margin-right: 10px; }
        .tab-grp { display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 10px; cursor: pointer; background: none; border: none; font-weight: bold; color: #666; }
        .tab.active { color: var(--p); border-bottom: 3px solid var(--p); }
        .f-view { display: none; } .f-view.active { display: block; }

        /* K·∫æT QU·∫¢ THI ƒê·∫∏P M·∫ÆT (NEW) */
        #result-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 11000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .result-card { background: white; width: 90%; max-width: 420px; padding: 40px 30px; border-radius: 24px; text-align: center; position: relative; animation: popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 30px 60px rgba(0,0,0,0.5); }
        /* Vi·ªÅn c·∫ßu v·ªìng */
        .result-card::before { content: ''; position: absolute; inset: -5px; z-index: -1; background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000); border-radius: 28px; background-size: 400%; animation: glow 20s linear infinite; }
        .result-card::after { content: ''; position: absolute; inset: 0; background: white; border-radius: 24px; z-index: -1; }

        @keyframes glow { 0% { background-position: 0 0; } 50% { background-position: 400% 0; } 100% { background-position: 0 0; } }
        @keyframes popUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }

        .res-icon { font-size: 80px; margin-bottom: 10px; display: inline-block; animation: bounce 2s infinite; text-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .res-title { font-size: 1.2rem; color: #666; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .res-score { font-size: 4.5rem; font-weight: 800; background: linear-gradient(to right, #2563eb, #db2777); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 5px 0; line-height: 1; }
        .res-time { font-size: 1.1rem; color: #555; background: #f3f4f6; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 20px; font-weight: 600; }
        .res-msg { font-size: 1.1rem; color: #333; margin-bottom: 30px; line-height: 1.5; font-weight: 500; }
        .res-btn { background: linear-gradient(135deg, #2563eb, #06b6d4); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3); width: 100%; }
        .res-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(37, 99, 235, 0.5); filter: brightness(1.1); }

        /* HEADER & NAV */
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 100; flex-shrink: 0; }
        .nav-bar { display: flex; justify-content: center; gap: 10px; padding: 10px; background: #fff; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .nav-btn { padding: 8px 16px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer; font-weight: 600; color: #666; width: auto; margin-top: 0; }
        .nav-btn.active { background: var(--p); color: white; }

        /* LAYOUT */
        #main-app { display: none; flex-direction: column; height: 100%; }
        .container { flex: 1; overflow-y: auto; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .section { display: none; height: 100%; } .section.active { display: block; }

        /* PROFILE */
        .profile-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .score-badge { padding: 4px 10px; border-radius: 12px; font-weight: bold; color: white; font-size: 0.9rem; }
        .s-low { background: var(--danger); } .s-mid { background: var(--warning); } .s-high { background: var(--success); }

        /* QUIZ & TOP 10 */
        .quiz-layout { display: flex; gap: 20px; height: 100%; flex-wrap: wrap; }
        .quiz-main { flex: 3; display: flex; flex-direction: column; min-width: 300px; }
        .quiz-sidebar { flex: 1; background: white; border-radius: 12px; padding: 15px; border: 1px solid #eee; height: fit-content; min-width: 250px; }
        .paper-header { background: #fff; border: 2px solid #000; padding: 15px; margin-bottom: 20px; font-family: 'Times New Roman', serif; display: flex; justify-content: space-between; align-items: flex-start; }
        .paper-info div { margin-bottom: 5px; font-size: 1.1rem; }
        
        #timer-box { font-size: 1.5rem; font-weight: bold; color: #2563eb; border: 2px solid #2563eb; padding: 5px 15px; border-radius: 8px; display: inline-block; margin-bottom: 5px; min-width: 100px; text-align: center; }
        .status-box { text-align: right; }

        .top-list { list-style: none; padding: 0; margin: 0; }
        .top-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; align-items: center; }
        .top-rank { font-weight: bold; width: 25px; display: inline-block; }
        .top-1 { color: #eab308; } .top-2 { color: #94a3b8; } .top-3 { color: #b45309; }
        .top-time { font-size: 0.75rem; color: #666; margin-left: 5px; }

        /* QUESTION CARD */
        .q-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 300px; display: flex; flex-direction: column; justify-content: center; font-family: 'Times New Roman', serif; font-size: 1.15rem; line-height: 1.5; }
        .part-label { font-family: 'Segoe UI', sans-serif; background: #dbeafe; color: #1e40af; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; display: inline-block; margin-bottom: 15px; }
        .q-img { display: block; max-width: 100%; height: auto; max-height: 250px; margin: 15px auto; border: 1px solid #eee; border-radius: 8px; }
        .opt-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .opt-item { font-family: 'Segoe UI', sans-serif; font-size: 1rem; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .opt-item:hover { background: #f9fafb; border-color: var(--p); }
        .opt-item.selected { background: #eff6ff; border-color: var(--p); color: var(--p); font-weight: bold; }
        .review-correct { background: #dcfce7 !important; border-color: #22c55e !important; color: #15803d !important; }
        .review-wrong { background: #fee2e2 !important; border-color: #ef4444 !important; color: #b91c1c !important; }
        .tf-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-family: 'Segoe UI', sans-serif; font-size: 1rem; }
        .tf-table td { padding: 8px 0; border-bottom: 1px dashed #eee; }
        .tf-btn { padding: 5px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .tf-btn.selected { background: var(--p); color: white; border-color: var(--p); }
        .short-inp { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-top: 10px; box-sizing: border-box; }

        /* FOOTER */
        .footer-nav { background: white; padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #grid-panel { position: absolute; bottom: 70px; left: 0; right: 0; background: white; padding: 20px; border-top: 1px solid #ccc; display: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); max-height: 60vh; overflow-y: auto; z-index: 50; }
        .grid-sec-title { font-weight: bold; margin: 10px 0 5px 0; color: #666; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 5px; font-family: 'Segoe UI', sans-serif; }
        .grid-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .q-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 13px; display: flex; justify-content: center; align-items: center; }
        .q-btn.done { background: var(--success); color: white; border-color: var(--success); }
        .q-btn.current { border: 2px solid var(--p); font-weight: bold; transform: scale(1.1); }

        /* E-LEARNING & INFO */
        .lecture-layout { display: flex; gap: 20px; height: 100%; flex-wrap: wrap; }
        .lecture-list { flex: 1; min-width: 250px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; overflow-y: auto; max-height: calc(100vh - 180px); }
        .lecture-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .lecture-item.active { background: #eff6ff; color: var(--p); font-weight: bold; border-left: 4px solid var(--p); }
        
        .lecture-viewer { flex: 3; min-width: 300px; background: #000; border-radius: 8px; overflow: hidden; height: 100%; min-height: 400px; position: relative; }
        .lecture-viewer.fullscreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; border-radius: 0; }
        
        .lecture-iframe { width: 100%; height: 100%; border: none; }
        
        /* N√öT PH√ìNG TO */
        #fullscreen-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; z-index: 10; display: none; }
        #fullscreen-btn:hover { background: rgba(0,0,0,0.8); }

        .doc-section { margin-bottom: 20px; }
        .doc-header { font-size: 1.2rem; font-weight: bold; border-bottom: 2px solid var(--p); padding-bottom: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: var(--txt); }
        .chapter-title { font-weight: bold; font-size: 1.1rem; color: #1e40af; margin: 15px 0 10px 0; background: #dbeafe; padding: 10px 15px; border-radius: 6px; border-left: 4px solid #1e40af; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .chapter-title:hover { background: #bfdbfe; }
        .info-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; padding: 10px 0; }
        .info-grid.show { display: grid; }
        .info-card { background: white; border: 1px solid #eee; border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.3s; }
        .info-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--p); }
        .info-img { width: 100%; height: 140px; object-fit: cover; }
        .info-title { padding: 10px; font-weight: 600; font-size: 0.9rem; text-align: center; }
        
        /* LIGHTBOX & PDF MODAL */
        #lightbox, #pdf-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #lightbox img { max-width: 90%; max-height: 80vh; border-radius: 4px; }
        
        .pdf-container { width: 90%; height: 90%; background: white; border-radius: 8px; position: relative; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .pdf-header { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; background: #f9fafb; border-radius: 8px 8px 0 0; }
        .pdf-frame { flex: 1; width: 100%; border: none; border-radius: 0 0 8px 8px; }

        .chat-btn { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: var(--p); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 900; }
        .chat-box { position: fixed; bottom: 150px; right: 20px; width: 320px; height: 400px; background: white; border-radius: 12px; box-shadow: 0 5px 30px rgba(0,0,0,0.15); display: none; flex-direction: column; z-index: 900; border: 1px solid #eee; }

        @media (max-width: 768px) {
            .lecture-layout { flex-direction: column; }
            .lecture-viewer { min-height: 250px; }
            .quiz-layout { flex-direction: column; }
            .quiz-sidebar { order: -1; }
        }
    </style>
</head>
<body>

    <div id="result-modal">
        <div class="result-card">
            <div class="res-icon">üèÜ</div>
            <div class="res-title">K·∫øt Qu·∫£ B√†i Thi</div>
            <div class="res-score" id="res-score">0.0</div>
            <div class="res-time" id="res-time">‚è± 00p 00s</div>
            <div class="res-msg" id="res-msg">L·ªùi nh·∫Øn...</div>
            <button class="res-btn" onclick="closeResult()">Xem Chi Ti·∫øt & Gi·∫£i</button>
        </div>
    </div>

    <div id="auth-overlay">
        <div class="auth-card">
            <h2 style="color:var(--p);margin-top:0">Mathpro</h2>
            <div class="tab-grp">
                <button class="tab active" onclick="switchTab('login')">ƒêƒÉng Nh·∫≠p</button>
                <button class="tab" onclick="switchTab('reg')">ƒêƒÉng K√Ω</button>
            </div>
            <div id="v-login" class="f-view active">
                <input id="l-email" class="inp" placeholder="Email" value="hocsinh@mathpro.edu.vn">
                <input id="l-pass" type="password" class="inp" placeholder="M·∫≠t kh·∫©u" value="123456">
                <button class="btn" onclick="doLogin()">V√†o L·ªõp</button>
            </div>
            <div id="v-reg" class="f-view">
                <input id="r-name" class="inp" placeholder="H·ªç t√™n">
                <input id="r-email" class="inp" placeholder="Email">
                <input id="r-pass" type="password" class="inp" placeholder="M·∫≠t kh·∫©u">
                <button class="btn" style="background:#16a34a" onclick="doRegister()">T·∫°o T√†i Kho·∫£n</button>
            </div>
            <button class="btn google-btn" onclick="doGoogle()">
                <svg class="g-icon" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg> Ti·∫øp t·ª•c v·ªõi Google
            </button>
        </div>
    </div>

    <div id="info-modal">
        <div class="modal-card">
            <h3 style="color:var(--p)">C·∫≠p Nh·∫≠t Th√¥ng Tin</h3>
            <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">Vui l√≤ng nh·∫≠p t√™n v√† l·ªõp ƒë·ªÉ ghi nh·∫≠n ƒëi·ªÉm thi.</p>
            <input id="u-fullname" class="inp" placeholder="H·ªç v√† t√™n (VD: Nguy·ªÖn VƒÉn A)">
            <input id="u-class" class="inp" placeholder="L·ªõp (VD: 12A1)">
            <button class="btn" onclick="saveUserInfo()">L∆∞u & B·∫Øt ƒê·∫ßu</button>
        </div>
    </div>

    <div id="main-app">
        <header>
            <strong style="font-size:1.3rem;color:var(--p)">Mathpro</strong>
            <div>
                <span id="u-name-display" style="font-weight:bold;margin-right:10px">H·ªçc sinh</span>
                <button class="nav-btn" onclick="nav('profile')" style="background:#e0f2fe; color:var(--p); margin-right:5px">üë§ C√° nh√¢n</button>
                <button class="nav-btn" style="background:#fee2e2;color:red" onclick="doLogout()">Tho√°t</button>
            </div>
        </header>

        <div class="nav-bar">
            <button class="nav-btn active" onclick="nav('lecture')">B√†i Gi·∫£ng</button>
            <button class="nav-btn" onclick="nav('docs')">T√†i Li·ªáu</button>
            <button class="nav-btn" onclick="nav('quiz')">Luy·ªán Thi</button>
        </div>

        <div class="container">
            <div id="sec-lecture" class="section active">
                <div class="card" style="height:100%; box-sizing:border-box; display:flex; flex-direction:column; background:white; padding:15px; border-radius:12px;">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">üì∫ Kho B√†i Gi·∫£ng</h3>
                    <div class="lecture-layout">
                        <div class="lecture-list" id="lecture-list"></div>
                        <div class="lecture-viewer" id="lecture-viewer">
                            <iframe id="main-frame" class="lecture-iframe" src="" allowfullscreen></iframe>
                            <div id="viewer-placeholder" class="lecture-placeholder">
                                <div style="font-size:3rem;">‚ñ∂Ô∏è</div><p>Ch·ªçn b√†i gi·∫£ng ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            </div>
                            <button id="fullscreen-btn" onclick="toggleFullscreen()">‚õ∂ Ph√≥ng to</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-docs" class="section">
                <div class="profile-card">
                    <h3 style="margin-top:0">üìÇ Kho PDF</h3>
                    <div style="padding:10px; background:#eff6ff; border-left:4px solid var(--p); margin-bottom:10px; border-radius:4px;">
                        <b>üìÑ ƒê·ªÅ c∆∞∆°ng √în t·∫≠p Ch∆∞∆°ng 1.pdf</b><br><a href="#" style="color:var(--p);text-decoration:none;font-size:0.9rem;">‚¨áÔ∏è T·∫£i xu·ªëng</a>
                    </div>
                    
                    <div style="padding:10px; background:#fdf2f8; border-left:4px solid #db2777; border-radius:4px; margin-top:10px;">
                        <div style="margin-bottom:5px"><b>üìÑ ƒê·ªÅ 1: Gi·ªØa HK1 (Tham kh·∫£o).pdf</b></div>
                        <div style="display:flex; gap:10px;">
                            <button class="nav-btn" style="padding:5px 15px; background:white; border:1px solid #db2777; color:#db2777; font-size:0.8rem" onclick="viewPDF('ƒê·ªÄ 1 - GI·ªÆA HK1-KH·ªêI 12 - 24 -25.pdf')">üëÅÔ∏è Xem ngay</button>
                            <a href="ƒê·ªÄ 1 - GI·ªÆA HK1-KH·ªêI 12 - 24 -25.pdf" download style="color:#db2777;text-decoration:none;font-size:0.9rem; align-self:center;">‚¨áÔ∏è T·∫£i xu·ªëng</a>
                        </div>
                    </div>
                    <div style="padding:10px; background:#fdf2f8; border-left:4px solid #db2777; border-radius:4px; margin-top:10px;">
                        <div style="margin-bottom:5px"><b>üìÑ ƒê·ªÅ 2: Gi·ªØa HK1 (Tham kh·∫£o).pdf</b></div>
                        <div style="display:flex; gap:10px;">
                            <button class="nav-btn" style="padding:5px 15px; background:white; border:1px solid #db2777; color:#db2777; font-size:0.8rem" onclick="viewPDF('ƒê·ªÄ 2- GI·ªÆA HK1-KH·ªêI 12 - ƒê·ªÄ THAM KH·∫¢O.pdf')">üëÅÔ∏è Xem ngay</button>
                            <a href="ƒê·ªÄ 2- GI·ªÆA HK1-KH·ªêI 12 - ƒê·ªÄ THAM KH·∫¢O.pdf" download style="color:#db2777;text-decoration:none;font-size:0.9rem; align-self:center;">‚¨áÔ∏è T·∫£i xu·ªëng</a>
                        </div>
                    </div>
                    <div style="padding:10px; background:#fdf2f8; border-left:4px solid #db2777; border-radius:4px; margin-top:10px;">
                        <div style="margin-bottom:5px"><b>üìÑ ƒê·ªÅ 3: Gi·ªØa HK1 (Tham kh·∫£o).pdf</b></div>
                        <div style="display:flex; gap:10px;">
                            <button class="nav-btn" style="padding:5px 15px; background:white; border:1px solid #db2777; color:#db2777; font-size:0.8rem" onclick="viewPDF('ƒê·ªÄ 3- GI·ªÆA HK1-KH·ªêI 12 - ƒê·ªÄ THAM KH·∫¢O.pdf')">üëÅÔ∏è Xem ngay</button>
                            <a href="ƒê·ªÄ 3- GI·ªÆA HK1-KH·ªêI 12 - ƒê·ªÄ THAM KH·∫¢O.pdf" download style="color:#db2777;text-decoration:none;font-size:0.9rem; align-self:center;">‚¨áÔ∏è T·∫£i xu·ªëng</a>
                        </div>
                    </div>
                    <div style="padding:10px; background:#fdf2f8; border-left:4px solid #db2777; border-radius:4px; margin-top:10px;">
                        <div style="margin-bottom:5px"><b>üìÑ ƒê·ªÅ 4: Gi·ªØa HK1 (Tham kh·∫£o).pdf</b></div>
                        <div style="display:flex; gap:10px;">
                            <button class="nav-btn" style="padding:5px 15px; background:white; border:1px solid #db2777; color:#db2777; font-size:0.8rem" onclick="viewPDF('ƒê·ªÄ 4- GI·ªÆA HK1-KH·ªêI 12 - ƒê·ªÄ THAM KH·∫¢O.pdf')">üëÅÔ∏è Xem ngay</button>
                            <a href="ƒê·ªÄ 4- GI·ªÆA HK1-KH·ªêI 12 - ƒê·ªÄ THAM KH·∫¢O.pdf" download style="color:#db2777;text-decoration:none;font-size:0.9rem; align-self:center;">‚¨áÔ∏è T·∫£i xu·ªëng</a>
                        </div>
                    </div>
                </div>
                
                <div class="doc-section">
                    <div class="doc-header">üñºÔ∏è G√≥c Infographic & Phi·∫øu H·ªçc T·∫≠p</div>
                    <div class="chapter-title" onclick="toggleInfo('c1')">üìö Ch∆∞∆°ng 1: ·ª®ng d·ª•ng ƒë·∫°o h√†m <span style="font-size:0.8em">‚ñº</span></div>
                    <div class="info-grid show" id="info-c1"></div>
                    <div class="chapter-title" onclick="toggleInfo('c3')">üìö Ch∆∞∆°ng 3: Th·ªëng k√™ <span style="font-size:0.8em">‚ñº</span></div>
                    <div class="info-grid" id="info-c3"></div>
                    <div class="chapter-title" onclick="toggleInfo('pht')">üìù Phi·∫øu h·ªçc t·∫≠p <span style="font-size:0.8em">‚ñº</span></div>
                    <div class="info-grid" id="info-pht"></div>
                </div>
            </div>

            <div id="sec-quiz" class="section" style="flex-direction:column">
                <div class="quiz-layout">
                    <div class="quiz-main">
                        <div class="paper-header">
                            <div class="paper-info">
                                <div><b>H·ªç t√™n:</b> <span id="q-name">...</span></div>
                                <div><b>L·ªõp:</b> <span id="q-class">...</span></div>
                            </div>
                            <div class="status-box">
                                <div style="font-size:0.9rem; color:#666; margin-bottom:5px;">Th·ªùi gian l√†m b√†i</div>
                                <div id="timer-box">00:00:00</div>
                                <div style="color:red; font-weight:bold; font-size:0.9rem" id="exam-status">ƒêANG L√ÄM B√ÄI</div>
                            </div>
                        </div>
                        <div id="quiz-area" style="flex:1; display:flex; flex-direction:column; justify-content:center;"></div>
                    </div>
                    <div class="quiz-sidebar">
                        <h4 style="margin-top:0; border-bottom:2px solid #eab308; padding-bottom:5px;">üèÜ B·∫£ng V√†ng (Top 10)</h4>
                        <div id="top-loading" style="display:none; color:#666; font-size:0.9rem; text-align:center;">ƒêang t·∫£i...</div>
                        <ul class="top-list" id="top-list"></ul>
                    </div>
                </div>
            </div>

            <div id="sec-profile" class="section">
                <div class="profile-card">
                    <h3>üë§ Th√¥ng Tin C√° Nh√¢n</h3>
                    <p><b>H·ªç t√™n:</b> <span id="p-fullname">...</span></p>
                    <p><b>L·ªõp:</b> <span id="p-class">...</span></p>
                    <p><b>Email:</b> <span id="p-email">...</span></p>
                </div>
                <div class="profile-card">
                    <h3>üïí L·ªãch S·ª≠ L√†m B√†i</h3>
                    <div id="history-list"><p style="color:#666">Ch∆∞a c√≥ b√†i thi n√†o.</p></div>
                </div>
            </div>
        </div>

        <div id="footer-nav" class="footer-nav" style="display:none">
            <button class="nav-btn" onclick="moveQ(-1)">‚¨ÖÔ∏è Tr∆∞·ªõc</button>
            <button class="nav-btn" style="border:1px solid var(--p); background:white; color:var(--p)" onclick="toggleGrid()">üî¢ Danh s√°ch</button>
            <button class="nav-btn" onclick="moveQ(1)">Sau ‚û°Ô∏è</button>
            <button class="nav-btn" style="background:var(--danger); color:white" onclick="submitExam()" id="submit-btn">N·ªòP B√ÄI</button>
        </div>
        
        <div id="grid-panel">
            <div class="grid-sec-title">PH·∫¶N I (12 C√¢u)</div> <div class="grid-row" id="grid-p1"></div>
            <div class="grid-sec-title">PH·∫¶N II (2 C√¢u)</div> <div class="grid-row" id="grid-p2"></div>
            <div class="grid-sec-title">PH·∫¶N III (4 C√¢u)</div> <div class="grid-row" id="grid-p3"></div>
        </div>
    </div>

    <div id="lightbox" onclick="this.style.display='none'">
        <span style="color:white; font-size:40px; position:absolute; top:20px; right:30px; cursor:pointer">√ó</span>
        <img id="lightbox-img" src="">
        <div id="lightbox-caption" style="color:white; margin-top:15px; font-weight:bold"></div>
    </div>
    <div id="pdf-modal">
        <div class="pdf-container">
            <div class="pdf-header">
                <span id="pdf-title">T√†i li·ªáu</span>
                <button onclick="document.getElementById('pdf-modal').style.display='none'" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#ef4444">√ó</button>
            </div>
            <iframe id="pdf-frame" class="pdf-frame" src=""></iframe>
        </div>
    </div>

    <div class="chat-btn" onclick="toggleChat()">üí¨</div>
    <div class="chat-box" id="chat-box">
        <div style="padding:10px;background:var(--p);color:white;font-weight:bold">Tr·ª£ l√Ω AI</div>
        <div style="flex:1;padding:10px;overflow-y:auto;background:#f9f9f9" id="chat-msgs"><div class="msg bot">Ch√†o em!</div></div>
        <div style="padding:10px;border-top:1px solid #eee;display:flex"><input id="chat-inp" class="inp" style="margin:0;flex:1"><button class="nav-btn" style="margin-left:5px; background:var(--p); color:white" onclick="sendChat()">G·ª≠i</button></div>
    </div>

    <script>
        const CFG={apiKey:"AIzaSyC1RdQm6whSY6afs5ueEXYaBl6E31oIcS0",authDomain:"mathpro-db.firebaseapp.com",projectId:"mathpro-db"};
        const GEMINI="AIzaSyBKWlAMRP32ubiF3WoLQR57z3RamEhlJy0";
        const SHEET="https://script.google.com/macros/s/AKfycbw91ovDMxBgT2yuBcoK0gc_bznQpwaUVyXowUD_C3kBJOWImpOTQJeEgcuVrBa32zfVmA/exec";
        let auth, user, currentQ=0, answers={}, userData={name:"", class:""}, isReviewMode = false;
        
        let timerInterval;
        let secondsElapsed = 0;
        let QUESTIONS = []; 

        const LECTURES = [
            { id: 1, title: "B√†i 1: T√≠nh ƒë∆°n ƒëi·ªáu", type: "elearning", url: "baigiang-bai1/index.html" },
            { id: 2, title: "B√†i 2: C·ª±c tr·ªã h√†m s·ªë", type: "elearning", url: "baigiang-bai2/index.html" },
            { id: 3, title: "B√†i 3: GTLN - GTNN", type: "elearning", url: "baigiang-bai3/index.html" },
	        { id: 4, title: "B√†i 3: ƒê∆∞·ªùng Ti·ªám C·∫≠n", type: "elearning", url: "baigiang-bai4/index.html" },
            { id: 5, title: "B√†i 5: Kh·∫£o s√°t h√†m s·ªë", type: "elearning", url: "baigiang-bai5/index.html" }
        ];
        
        const INFO_DATA = {
            c1: [
                { title: "S∆° ƒë·ªì: T√≠nh ƒë∆°n ƒëi·ªáu", src: "CH∆Ø∆†NG 1/unnamed.jpg" }, 
                { title: "S∆° ƒë·ªì: C·ª±c tr·ªã h√†m s·ªë", src: "CH∆Ø∆†NG 1/GTLN - GTNN c·ªßa h√†m s·ªë.png" },
                { title: "S∆° ƒë·ªì: GTLN - GTNN", src: "CH∆Ø∆†NG 1/ƒê∆∞·ªùng Ti·ªám c·∫≠n c·ªßa ƒê·ªì th·ªã h√†m s·ªë.png" }, 
                { title: "S∆° ƒë·ªì: Ti·ªám c·∫≠n", src: "CH∆Ø∆†NG 1/Kh·∫£o s√°t h√†m s·ªë.png" }
            ],
            c3: [
                { title: "S∆° ƒë·ªì: Kho·∫£ng Bi·∫øn thi√™n v√† Kho·∫£ng t·ª© ph√¢n v·ªã", src: "CH∆Ø∆†NG 3/Kho·∫£ng Bi·∫øn thi√™n v√† Kho·∫£ng t·ª© ph√¢n v·ªã.png" }, 
                { title: "S∆° ƒë·ªì: Ph√¢n b·ªë t·∫ßn s·ªë gh√©p l·ªõp", src: "CH∆Ø∆†NG 3/Ph√¢n b·ªë t·∫ßn s·ªë gh√©p l·ªõp.jpg" },
                { title: "S∆° ƒë·ªì: Th·ªëng K√™ 12 _ t·ªïng h·ª£p", src: "CH∆Ø∆†NG 3/Th·ªëng K√™ 12 _ t·ªïng h·ª£p.png" }
            ],
            pht: [
                { title: "Phi·∫øu h·ªçc t·∫≠p: T√≠nh ƒë∆°n ƒëi·ªáu", src: "PHI·∫æU H·ªåC T·∫¨P/T√≠nh ƒë∆°n ƒëi·ªáu.png" }, 
                { title: "Phi·∫øu h·ªçc t·∫≠p: C·ª±c tr·ªã h√†m s·ªë", src: "PHI·∫æU H·ªåC T·∫¨P/C·ª±c tr·ªã.png" },
                { title: "Phi·∫øu h·ªçc t·∫≠p: GTLN - GTNN", src: "PHI·∫æU H·ªåC T·∫¨P/GTLN - GTNN.png" }, 
                { title: "Phi·∫øu h·ªçc t·∫≠p: Ti·ªám c·∫≠n", src: "PHI·∫æU H·ªåC T·∫¨P/Kh·∫£o S√°t H√†m S·ªë.png" }
            ]
        };

        const MASTER_DATA = [
            {type:1, id:1, q:`Cho t·ª© di·ªán ABCD, g·ªçi I, J l·∫ßn l∆∞·ª£t l√† trung ƒëi·ªÉm c·ªßa AB v√† CD. ƒê·∫≥ng th·ª©c n√†o sau ƒë√¢y sai? <img src="img/c1.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{AC}+\\vec{BD})\\)", "B. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{DC}+\\vec{AD}+\\vec{BD})\\)", "C. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{AD}+\\vec{BC})\\)", "D. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{AC}+\\vec{BD})\\)"], a:"B"},
            {type:1, id:2, q:`H√†m s·ªë c√≥ ƒë·ªì th·ªã nh∆∞ h√¨nh v·∫Ω sau ƒë·ªìng bi·∫øn tr√™n kho·∫£ng n√†o d∆∞·ªõi ƒë√¢y? <img src="img/c2.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. (-3; 1)", "B. (-1; 1)", "C. (1; +‚àû)", "D. (-1; +‚àû)"], a:"B"},
            {type:1, id:3, q:"Cho h√†m s·ªë \\(y=\\frac{x-1}{x+1}\\). Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y ƒë√∫ng?", opts:["A. ƒê·ªìng bi·∫øn tr√™n R\\{-1}", "B. Ngh·ªãch bi·∫øn tr√™n R\\{-1}", "C. ƒê·ªìng bi·∫øn (-‚àû;-1)U(-1;+‚àû)", "D. ƒê·ªìng bi·∫øn t·ª´ng kho·∫£ng"], a:"D"},
            {type:1, id:4, q:"H√†m s·ªë \\(y=\\ln(4-x^2)\\) ƒë·ªìng bi·∫øn tr√™n kho·∫£ng?", opts:["A. (-2; 2)", "B. (-2; 0)", "C. (0; 2)", "D. (-‚àû; 2)"], a:"B"},
            {type:1, id:5, q:`Cho h√†m s·ªë y=f(x) c√≥ b·∫£ng bi·∫øn thi√™n. M·ªánh ƒë·ªÅ n√†o sai? <img src="img/c5.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. Ngh·ªãch bi·∫øn (-‚àû; 2)", "B. ƒê·ªìng bi·∫øn (2; +‚àû)", "C. ƒê·ªìng bi·∫øn (2; 5)", "D. Ngh·ªãch bi·∫øn (0; 2)"], a:"A"},
            {type:1, id:6, q:`Cho h√¨nh h·ªôp ABCD.A'B'C'D'. T√≠nh t·ªïng \\(\\vec{AB}+\\vec{AD}+\\vec{A'C'}\\) <img src="img/c6.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. \\(2\\vec{AA'}\\)", "B. \\(2\\vec{AC}\\)", "C. \\(2\\vec{C'A'}\\)", "D. \\(\\vec{0}\\)"], a:"B"},
            {type:1, id:7, q:"Cho h√¨nh l·∫≠p ph∆∞∆°ng ABCD.A'B'C'D'. Kh·∫≥ng ƒë·ªãnh n√†o sai?", opts:["A. (AB,A'D')=90", "B. (AB,A'C')=45", "C. (AC,B'D')=90", "D. (A'A,CB')=45"], a:"D"},
            {type:1, id:8, q:"Cho h√†m s·ªë y=f(x) li√™n t·ª•c tr√™n R c√≥ ƒë·∫°o h√†m \\(f'(x)=x(1-x)^2(x-2)^3\\). Ngh·ªãch bi·∫øn tr√™n?", opts:["A. (0; 2)", "B. (-‚àû; 0)", "C. (1; +‚àû)", "D. (-1; 1)"], a:"A"},
            {type:1, id:9, q:"T√¨m kho·∫£ng ngh·ªãch bi·∫øn c·ªßa h√†m s·ªë bi·∫øt \\(f'(x)=3x(x-1)^2(x+2)^3\\).", opts:["A. (-2;0) v√† (1;+‚àû)", "B. (-‚àû;-2) v√† (0;1)", "C. (-‚àû;-2) v√† (0;+‚àû)", "D. (-2; 0)"], a:"D"},
            {type:1, id:10, q:"Gi·∫£ s·ª≠ l∆∞·ª£ng h√†ng b√°n ra x theo gi√° p l√† \\(x=\\frac{250-p}{0.01p}\\). Kh·∫≥ng ƒë·ªãnh ƒë√∫ng?", opts:["A. TƒÉng khi gi√° tƒÉng", "B. Gi·∫£m khi gi√° gi·∫£m", "C. Ko ƒë·ªïi", "D. Gi·∫£m khi gi√° tƒÉng"], a:"D"},
            {type:1, id:11, q:`V·∫≠n t·ªëc ch·∫•t ƒëi·ªÉm tƒÉng khi t thu·ªôc kho·∫£ng n√†o? <img src="img/c11.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. (-3; +‚àû)", "B. (0; 2)", "C. (2; +‚àû)", "D. (0; +‚àû)"], a:"C"},
            {type:1, id:12, q:`H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng n√†o? <img src="img/c12.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. (0; 1)", "B. (-‚àû; 4)", "C. (-1; 0)", "D. (1; +‚àû)"], a:"A"},
            {type:2, id:13, q:"Trong kh√¥ng gian, cho hai vect∆° a v√† b c√πng c√≥ ƒë·ªô d√†i b·∫±ng 1, g√≥c 45 ƒë·ªô.", subs:["a) \\(\\vec{a}.\\vec{b}=\\frac{\\sqrt{2}}{2}\\).", "b) \\(|\\vec{a}+\\vec{b}|=2+\\sqrt{2}\\).", "c) \\((\\vec{a}+3\\vec{b}).(\\vec{a}-2\\vec{b})=-5+\\frac{\\sqrt{2}}{2}\\).", "d) \\(|\\vec{a}-\\sqrt{2}\\vec{b}|=0\\)."], ans:["S","S","ƒê","ƒê"]},
            {type:2, id:14, q:"X√©t h√†m s·ªë \\(y=\\frac{1}{3}x^3+(m+1)x^2+(m^2+2m)x-3\\) m l√† tham s·ªë.", subs:["a) H√†m s·ªë ngh·ªãch bi·∫øn tr√™n \\(\\mathbb{R}\\) v·ªõi m·ªçi gi√° tr·ªã c·ªßa m.", "b) H√†m s·ªë ngh·ªãch bi·∫øn tr√™n kho·∫£ng (-1; 1) khi v√† ch·ªâ khi \\(m \\ge -1\\).", "c) Kh√¥ng t·ªìn t·∫°i gi√° tr·ªã m ƒë·ªÉ h√†m s·ªë ƒë·ªìng bi·∫øn tr√™n \\(\\mathbb{R}\\).", "d) T·∫≠p x√°c ƒë·ªãnh c·ªßa h√†m s·ªë l√† \\(D=\\mathbb{R}\\setminus\\{3\\}\\)."], ans:["S","S","ƒê","S"]},
            {type:3, id:15, q:`H·∫±ng ng√†y m·ª±c n∆∞·ªõc c·ªßa m·ªôt con k√™nh l√™n xu·ªëng theo th·ªßy tri·ªÅu. ƒê·ªô s√¢u h (m) c·ªßa m·ª±c n∆∞·ªõc trong k√™nh t·∫°i th·ªùi ƒëi·ªÉm \\(t(h)(0\\le t\\le24)\\) trong ng√†y ƒë∆∞·ª£c x√°c ƒë·ªãnh b·ªüi c√¥ng th·ª©c \\(h=2\\cos(\\frac{\\pi t}{12}+\\frac{\\pi}{3})+5\\). G·ªçi (a;b) l√† kho·∫£ng th·ªùi gian trong ng√†y m√† ƒë·ªô s√¢u c·ªßa m·ª±c n∆∞·ªõc trong k√™nh tƒÉng d·∫ßn. T√≠nh gi√° tr·ªã c·ªßa \\(a+b\\).`, a:"28"},
            {type:3, id:16, q:`Ng∆∞·ªùi ta v·∫≠n chuy·ªÉn m·ªôt th√πng h√†ng c√≥ d·∫°ng h√¨nh h·ªôp ch·ªØ nh·∫≠t b·∫±ng c√°ch m√≥c 4 d√¢y c√°p v√†o 4 g√≥c tr√™n c·ªßa th√πng h√†ng v√† ƒë·∫ßu c√≤n l·∫°i m√≥c v√†o c·∫ßn c·∫©u nh∆∞ h√¨nh v·∫Ω. <img src="img/p3c2.png" class="q-img" onerror="this.style.display='none'"> Bi·∫øt r·∫±ng c√°c ƒëo·∫°n d√¢y c√°p c√≥ ƒë·ªô d√†i b·∫±ng nhau v√† g√≥c t·∫°o b·ªüi hai ƒëo·∫°n d√¢y c√°p ƒë·ªëi di·ªán nhau l√† \\(60^{\\circ}\\). Chi·∫øc c·∫ßn c·∫©u k√©o th√πng h√†ng l√™n theo ph∆∞∆°ng th·∫≥ng ƒë·ª©ng. Bi·∫øt r·∫±ng \\(F_{1}, F_{2}, F_{3}, F_{4}\\) ch·ªãu ƒë∆∞·ª£c t·ªëi ƒëa l·ª±c cƒÉng l√† 5 000 N. H·ªèi c·∫ßn c·∫©u n√¢ng ƒë∆∞·ª£c th√πng h√†ng c√≥ kh·ªëi l∆∞·ª£ng (ƒë∆°n v·ªã kg) t·ªëi ƒëa l√† bao nhi√™u (l√†m tr√≤n ƒë·∫øn h√†ng ƒë∆°n v·ªã)? L·∫•y \\(g=10~m/s^{2}\\).`, a:"1732"},
            {type:3, id:17, q:`Cho h√†m s·ªë \\(f(x)=x^{2}-2x\\). ƒê·∫∑t \\(g(x)=f(f(x))+1\\). Gi·∫£ s·ª≠ h√†m s·ªë \\(y=g(x)\\) ƒë·ªìng bi·∫øn tr√™n kho·∫£ng (a;b) v·ªõi \\(a\\in\\mathbb{R}, b\\in\\mathbb{R}\\). T√≠nh \\(a+b\\sqrt{2}\\).`, a:"1"},
            {type:3, id:18, q:`Th·ªÉ t√≠ch \\(V(cm^{3})\\) c·ªßa 1kg n∆∞·ªõc t·∫°i nhi·ªát ƒë·ªô \\(T(0^{\\circ}C\\le T\\le30^{\\circ}C)\\) ƒë∆∞·ª£c t√≠nh b·ªüi c√¥ng th·ª©c \\(V(T)=999,87-0,06426T+0,0058043T^{2}-0,0000679T^{3}.\\) Th·ªÉ t√≠ch n∆∞·ªõc \\(V(T)(0^{\\circ}C\\le T\\le30^{\\circ}C)\\) gi·∫£m trong kho·∫£ng nhi·ªát ƒë·ªô \\((a^{\\circ};b^{\\circ});\\) b l√†m tr√≤n ƒë·∫øn h√†ng ƒë∆°n v·ªã. T·ªïng \\(a+b\\) b·∫±ng bao nhi√™u?`, a:"4"}
        ];

        function switchTab(t){
            document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.f-view').forEach(f=>f.classList.remove('active'));
            if(t==='login'){document.querySelectorAll('.tab')[0].classList.add('active');document.getElementById('v-login').classList.add('active')}
            else{document.querySelectorAll('.tab')[1].classList.add('active');document.getElementById('v-reg').classList.add('active')}
        }
        function doLogin(){auth.signInWithEmailAndPassword(document.getElementById('l-email').value,document.getElementById('l-pass').value).catch(e=>alert(e.message))}
        function doRegister(){auth.createUserWithEmailAndPassword(document.getElementById('r-email').value,document.getElementById('r-pass').value).catch(e=>alert(e.message))}
        function doGoogle(){auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message))}
        function doLogout(){auth.signOut().then(()=>location.reload())}

        function checkUserInfo(u) {
            const stored = localStorage.getItem('user_'+u.uid);
            if(stored) {
                userData = JSON.parse(stored);
                updateProfileUI();
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('main-app').style.display='flex';
                loadHistory();
            } else {
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('info-modal').style.display='flex';
            }
        }

        function standardizeName(str) { return str.replace(/\s+/g, ' ').trim().toLowerCase().replace(/(^|\s)\S/g, l => l.toUpperCase()); }

        function saveUserInfo() {
            let name = document.getElementById('u-fullname').value;
            let cls = document.getElementById('u-class').value;
            if(!name || !cls) { alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß H·ªç t√™n v√† L·ªõp!"); return; }
            name = standardizeName(name); cls = cls.trim().toUpperCase(); 
            userData = { name: name, class: cls };
            localStorage.setItem('user_'+user.uid, JSON.stringify(userData));
            document.getElementById('info-modal').style.display='none';
            document.getElementById('main-app').style.display='flex';
            updateProfileUI(); loadHistory();
        }

        function updateProfileUI() {
            document.getElementById('u-name-display').innerText = userData.name;
            document.getElementById('p-fullname').innerText = userData.name;
            document.getElementById('p-class').innerText = userData.class;
            document.getElementById('q-name').innerText = userData.name;
            document.getElementById('q-class').innerText = userData.class;
        }

        function startTimer() {
            clearInterval(timerInterval); secondsElapsed = 0; updateTimerDisplay();
            timerInterval = setInterval(() => { secondsElapsed++; updateTimerDisplay(); }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); }
        function updateTimerDisplay() {
            const h = Math.floor(secondsElapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((secondsElapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (secondsElapsed % 60).toString().padStart(2, '0');
            document.getElementById('timer-box').innerText = `${h}:${m}:${s}`;
        }
        function getDurationText() {
            const h = Math.floor(secondsElapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((secondsElapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (secondsElapsed % 60).toString().padStart(2, '0');
            return `${h}h ${m}p ${s}s`; 
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function nav(id){
            if(id !== 'lecture') {
                const iframe = document.getElementById('main-frame');
                if(iframe) { iframe.src = ""; iframe.style.display = 'none'; }
                const place = document.getElementById('viewer-placeholder');
                if(place) place.style.display = 'flex';
                document.getElementById('fullscreen-btn').style.display='none';
                document.querySelectorAll('.lecture-item').forEach(el => el.classList.remove('active'));
            }

            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            const qs = document.getElementById('sec-quiz');
            if(id === 'quiz') {
                isReviewMode = false; answers = {};
                let p1 = MASTER_DATA.filter(q => q.type === 1).slice(); 
                let p2 = MASTER_DATA.filter(q => q.type === 2).slice();
                let p3 = MASTER_DATA.filter(q => q.type === 3).slice();
                shuffleArray(p1); shuffleArray(p2); shuffleArray(p3);
                QUESTIONS = [...p1, ...p2, ...p3];
                
                document.getElementById('exam-status').innerText = "ƒêANG L√ÄM B√ÄI";
                document.getElementById('exam-status').style.color = "red";
                document.getElementById('submit-btn').style.display = "block";
                qs.classList.add('active'); qs.style.display='flex';
                document.getElementById('footer-nav').style.display='flex';
                currentQ = 0; startTimer(); renderQ(); fetchTop10();
            } else {
                stopTimer();
                qs.classList.remove('active'); qs.style.display='none';
                document.getElementById('sec-'+id).classList.add('active');
                document.getElementById('footer-nav').style.display='none';
            }
            const map = {'lecture':0, 'docs':1, 'quiz':2};
            if(map[id]!==undefined) document.querySelectorAll('.nav-bar .nav-btn')[map[id]].classList.add('active');
        }

        function viewPDF(url) {
            document.getElementById('pdf-title').innerText = url;
            document.getElementById('pdf-frame').src = url;
            document.getElementById('pdf-modal').style.display = 'flex';
        }

        function fetchTop10() {
            document.getElementById('top-loading').style.display = 'block';
            document.getElementById('top-list').innerHTML = '';
            fetch(SHEET)
            .then(res => res.json())
            .then(data => {
                document.getElementById('top-loading').style.display = 'none';
                let html = '';
                data.forEach((s, i) => {
                    let rank = i===0?'top-1':(i===1?'top-2':(i===2?'top-3':''));
                    let icon = i===0?'ü•á':(i===1?'ü•à':(i===2?'ü•â':`#${i+1}`));
                    html += `<li class="top-item"><div style="flex:1"><span class="top-rank ${rank}">${icon}</span> ${s.name} (${s.class})</div><div style="text-align:right"><span style="font-weight:bold;color:var(--p)">${s.score}</span><div class="top-time">${s.timeStr}</div></div></li>`;
                });
                document.getElementById('top-list').innerHTML = html;
            })
            .catch(err => { document.getElementById('top-loading').innerText = 'Ch∆∞a c√≥ d·ªØ li·ªáu'; });
        }

        function initLectures() {
            const list = document.getElementById('lecture-list'); if(!list) return;
            list.innerHTML = LECTURES.map((lec,i) => `<div class="lecture-item" onclick="playLecture(${i})" id="lec-btn-${i}"><span>üì∫</span> ${lec.title}</div>`).join('');
        }
        function playLecture(i) {
            document.querySelectorAll('.lecture-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`lec-btn-${i}`).classList.add('active');
            document.getElementById('viewer-placeholder').style.display = 'none';
            document.getElementById('main-frame').style.display = 'block';
            document.getElementById('main-frame').src = LECTURES[i].url;
            document.getElementById('fullscreen-btn').style.display = 'block';
        }

        function toggleFullscreen() {
            const viewer = document.getElementById('lecture-viewer');
            if(!viewer.classList.contains('fullscreen')) {
                viewer.classList.add('fullscreen');
                document.getElementById('fullscreen-btn').innerText = 'Thu nh·ªè';
            } else {
                viewer.classList.remove('fullscreen');
                document.getElementById('fullscreen-btn').innerText = '‚õ∂ Ph√≥ng to';
            }
        }

        function initInfographics() {
            ['c1', 'c3', 'pht'].forEach(id => {
                const list = document.getElementById('info-'+id); if(!list) return;
                list.innerHTML = INFO_DATA[id].map(inf => `<div class="info-card" onclick="openLightbox('${inf.src}', '${inf.title}')"><span style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.6);color:white;padding:2px 5px;border-radius:4px;font-size:0.8rem">Xem</span><img src="${inf.src}" class="info-img" onerror="this.src='https://via.placeholder.com/300x160?text=Ch∆∞a+c√≥+·∫£nh'"><div class="info-title">${inf.title}</div></div>`).join('');
            });
        }
        function toggleInfo(id) { document.getElementById('info-'+id).classList.toggle('show'); }
        function openLightbox(s,t) { document.getElementById('lightbox-img').src=s; document.getElementById('lightbox-caption').innerText=t; document.getElementById('lightbox').style.display='flex'; }

        function renderQ() {
            const q = QUESTIONS[currentQ];
            let html = `<div class="q-card"><div><span class="part-label">Ph·∫ßn ${q.type} - C√¢u ${currentQ + 1}</span></div><div class="q-content">${q.q}</div>`;
            if(q.type===1) {
                html+=`<div class="opt-list">`+q.opts.map(o=>{
                    let val = o.charAt(0);
                    let cls = isReviewMode ? (answers[q.id]===val ? (val===q.a ? 'review-correct' : 'review-wrong') : (val===q.a ? 'review-correct' : '')) : (answers[q.id]===val ? 'selected' : '');
                    return `<div class="opt-item ${cls}" onclick="${isReviewMode?'':'saveAns('+q.id+',\''+val+'\')'}">${o}</div>`;
                }).join('')+`</div>`;
            } else if(q.type===2) {
                html+=`<table class="tf-table">`+q.subs.map((s,i)=>{
                    let k = q.id+'_'+i;
                    let uAns = answers[k]; let rAns = q.ans[i];
                    let dCls = isReviewMode ? (uAns==='ƒê'?(rAns==='ƒê'?'review-correct':'review-wrong'):(rAns==='ƒê'?'review-correct':'')) : (uAns==='ƒê'?'selected':'');
                    let sCls = isReviewMode ? (uAns==='S'?(rAns==='S'?'review-correct':'review-wrong'):(rAns==='S'?'review-correct':'')) : (uAns==='S'?'selected':'');
                    return `<tr><td>${s}</td><td style="white-space:nowrap"><span class="tf-btn ${dCls}" onclick="${isReviewMode?'':'saveAns(\''+k+'\',\'ƒê\')'}">ƒê√∫ng</span><span class="tf-btn ${sCls}" onclick="${isReviewMode?'':'saveAns(\''+k+'\',\'S\')'}">Sai</span></td></tr>`;
                }).join('')+`</table>`;
            } else {
                let uVal = answers[q.id]||'';
                let style = isReviewMode ? (uVal.trim()===q.a ? 'border-color:#22c55e;color:#15803d' : 'border-color:#ef4444;color:#b91c1c') : '';
                html+=`<input class="short-inp" value="${uVal}" style="${style}" oninput="saveAns(${q.id},this.value)" ${isReviewMode?'readonly':''} placeholder="Nh·∫≠p ƒë√°p √°n...">`;
            }
            html+=`</div>`;
            document.getElementById('quiz-area').innerHTML=html;
            if(window.MathJax) MathJax.typesetPromise();
            updateGrid();
        }
        function saveAns(k,v){if(!isReviewMode){answers[k]=v;renderQ();}}
        function moveQ(d){const n=currentQ+d;if(n>=0&&n<QUESTIONS.length){currentQ=n;renderQ();}}
        function toggleGrid(){const p=document.getElementById('grid-panel');p.style.display=p.style.display==='block'?'none':'block';}
        function updateGrid(){
            const p1=QUESTIONS.map((q,i)=>renderBtn(q,i)).filter((_,i)=>QUESTIONS[i].type===1).join('');
            const p2=QUESTIONS.map((q,i)=>renderBtn(q,i)).filter((_,i)=>QUESTIONS[i].type===2).join('');
            const p3=QUESTIONS.map((q,i)=>renderBtn(q,i)).filter((_,i)=>QUESTIONS[i].type===3).join('');
            document.getElementById('grid-p1').innerHTML=p1;
            document.getElementById('grid-p2').innerHTML=p2;
            document.getElementById('grid-p3').innerHTML=p3;
        }
        function renderBtn(q,i){
            let done=false;
            if(q.type===1 && answers[q.id]) done=true;
            if(q.type===3 && answers[q.id]) done=true;
            if(q.type===2) for(let k=0;k<4;k++) if(answers[q.id+'_'+k]) done=true;
            return `<button class="q-btn ${done?'done':''} ${i===currentQ?'current':''}" onclick="currentQ=${i};renderQ();toggleGrid()">${i+1}</button>`;
        }

        // --- SUBMIT EXAM & SHOW MODAL ---
        function submitExam() {
            if(isReviewMode) return;
            stopTimer();
            const timeString = getDurationText(); 

            let s1=0, s2=0, s3=0;
            QUESTIONS.filter(q=>q.type===1).forEach(q=>{if(answers[q.id]===q.a) s1+=0.25});
            QUESTIONS.filter(q=>q.type===2).forEach(q=>{let c=0; q.ans.forEach((a,i)=>{if(answers[q.id+'_'+i]===a) c++}); s2+=[0,0.1,0.25,1.0,1.5][c]});
            QUESTIONS.filter(q=>q.type===3).forEach(q=>{if(answers[q.id]?.trim()===q.a) s3+=1.0});
            
            const total = (s1+s2+s3).toFixed(2);
            let msg = ""; let t = parseFloat(total);
            if(t < 5) msg = "C·ªë g·∫Øng h∆°n nh√©! ƒê·ª´ng n·∫£n ch√≠!";
            else if(t < 7) msg = "Kh√° t·ªët! H√£y √¥n t·∫≠p th√™m ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm cao h∆°n!";
            else if(t < 9) msg = "Gi·ªèi l·∫Øm! Ch·ªâ c√≤n m·ªôt ch√∫t n·ªØa l√† tuy·ªát ƒë·ªëi!";
            else msg = "Xu·∫•t s·∫Øc! B·∫°n l√† thi√™n t√†i to√°n h·ªçc!";

            // SHOW MODAL
            document.getElementById('res-score').innerText = total;
            document.getElementById('res-time').innerText = "‚è± " + timeString;
            document.getElementById('res-msg').innerText = msg;
            document.getElementById('result-modal').style.display = 'flex';
            
            saveHistory(total, answers);
            
            const fd = new FormData();
            fd.append("TenHocSinh", userData.name);
            fd.append("Lop", userData.class);
            fd.append("Diem", total);
            fd.append("ThoiGian", timeString);
            fetch(SHEET, {method:'POST', body:fd});
        }

        // --- CLOSE RESULT & REVIEW ---
        function closeResult() {
            document.getElementById('result-modal').style.display = 'none';
            // Chuy·ªÉn sang ch·∫ø ƒë·ªô xem l·∫°i b√†i
            // L·∫•y b√†i l√†m m·ªõi nh·∫•t (v·ª´a l∆∞u)
            let history = JSON.parse(localStorage.getItem('his_'+user.uid) || "[]");
            let latestIdx = history.length - 1;
            reviewExam(latestIdx);
        }

        function saveHistory(score, userAnswers) {
            let history = JSON.parse(localStorage.getItem('his_'+user.uid) || "[]");
            history.push({ date: new Date().toLocaleString(), score: score, answers: JSON.parse(JSON.stringify(userAnswers)) });
            localStorage.setItem('his_'+user.uid, JSON.stringify(history));
            loadHistory();
        }
        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('his_'+user.uid) || "[]");
            const list = document.getElementById('history-list');
            if(history.length === 0) return;
            let html = '';
            history.slice().reverse().forEach((h, idx) => {
                let realIdx = history.length - 1 - idx;
                let cls = h.score < 5 ? 's-low' : (h.score < 8 ? 's-mid' : 's-high');
                html += `<div class="history-item"><div><span>üìÖ ${h.date}</span></div><div><span class="score-badge ${cls}" style="margin-right:10px">${h.score}ƒë</span><button class="nav-btn" style="padding:5px 10px; font-size:0.8rem" onclick="reviewExam(${realIdx})">Xem l·∫°i</button></div></div>`;
            });
            list.innerHTML = html;
        }
        
        function reviewExam(index) {
            let history = JSON.parse(localStorage.getItem('his_'+user.uid) || "[]");
            let item = history[index];
            if(!item) return;
            
            isReviewMode = true; 
            answers = item.answers || {};
            QUESTIONS = [...MASTER_DATA]; 
            
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.getElementById('sec-quiz').classList.add('active');
            document.getElementById('sec-quiz').style.display='flex';
            document.getElementById('footer-nav').style.display='flex';
            document.getElementById('exam-status').innerText = "ƒêANG XEM L·∫†I (ƒêi·ªÉm: " + item.score + ")";
            document.getElementById('exam-status').style.color = "blue";
            document.getElementById('timer-box').innerText = "--:--:--"; 
            document.getElementById('submit-btn').style.display = "none";
            currentQ = 0; renderQ();
        }

        function toggleChat(){const b=document.getElementById('chat-box');b.style.display=b.style.display==='flex'?'none':'flex'}
        async function sendChat(){const i=document.getElementById('chat-inp'), t=i.value.trim(); if(!t)return; const b=document.getElementById('chat-msgs'); b.innerHTML+=`<div class="msg user">${t}</div>`; i.value=''; b.scrollTop=b.scrollHeight; try{const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:"Gi·∫£i ng·∫Øn: "+t}]}]})}); const d = await r.json(); b.innerHTML+=`<div class="msg bot">${d.candidates[0].content.parts[0].text}</div>`;}catch(e){b.innerHTML+=`<div class="msg bot">L·ªói AI</div>`}}

        window.onload=()=>{
            try{
                firebase.initializeApp(CFG); auth=firebase.auth();
                auth.onAuthStateChanged(u=>{
                    if(u){
                        user=u;
                        document.getElementById('p-email').innerText = u.email;
                        checkUserInfo(u);
                        initLectures(); initInfographics();
                    } else {
                        document.getElementById('auth-overlay').style.display='flex';
                        document.getElementById('main-app').style.display='none';
                        document.getElementById('info-modal').style.display='none';
                    }
                });
            }catch(e){alert("L·ªói: "+e.message)}
        };
    </script>
</body>
</html>